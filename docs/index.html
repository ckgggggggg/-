<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>订单图片 Viewer</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#111827; --card:#0f172a;
      --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: var(--bg); color:var(--text); }
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      background: rgba(17,24,39,.85);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .leftHead{ display:flex; flex-direction:column; gap:2px; }
    .leftHead strong{ font-size:15px; }
    .leftHead span{ font-size:12px; color:var(--muted); }

    .ctl{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button{
      background: rgba(15,23,42,.85);
      border:1px solid var(--border);
      color:var(--text);
      border-radius: 12px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
    }

    .search{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .search input{
      width: 260px;
      max-width: 52vw;
      background: rgba(15,23,42,.85);
      border:1px solid var(--border);
      color:var(--text);
      border-radius: 12px;
      padding:8px 10px;
      font-size:12px;
      outline:none;
    }
    .search input:focus{
      border-color: rgba(148,163,184,.45);
    }

    .wrap{
      max-width: 1300px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } }

    .panel{
      background: rgba(17,24,39,.85);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .ph{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.85);
      font-size:11px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background:var(--warn); }
    .dot.ok{ background:var(--ok); }
    .dot.bad{ background:var(--bad); }

    /* 左侧：订单列表 */
    .list{
      padding: 8px;
      max-height: calc(100vh - 160px);
      overflow:auto;
    }
    .item{
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .item:hover{ background: rgba(15,23,42,.45); border-color: rgba(148,163,184,.15); }
    .item.active{ background: rgba(15,23,42,.75); border-color: rgba(148,163,184,.25); }
    .item .id{
      font-size:12px;
      color: var(--text);
      word-break: break-all;
      line-height: 1.2;
    }
    .miniPill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .kbdTip{ padding:10px 12px; color:var(--muted); font-size:12px; }

    /* 右侧：订单信息 + 图片 */
    .main{ display:flex; flex-direction:column; gap:14px; }

    .meta{
      padding:12px 14px 14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border:1px dashed rgba(148,163,184,.35);
      border-radius: 12px;
      background: rgba(15,23,42,.35);
      font-size:12px;
    }
    .row .k{ color:var(--muted); }
    .row .v{ display:flex; align-items:center; gap:8px; }

    /* 图片网格 */
    .imgs{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 1100px){ .imgs{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 780px){ .imgs{ grid-template-columns: 1fr; } }

    .imgcard{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(2,6,23,.6);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 320px;
    }
    .imgTop{
      padding:10px 10px 8px;
      border-bottom:1px solid rgba(148,163,184,.12);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .imgTop .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .imgTop .idx{
      font-size:12px;
      color:var(--text);
    }
    .imgTop .order{
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 260px;
    }

    .imgBox{
      position:relative;
      flex: 1 1 auto;
      min-height: 210px;
      background: rgba(15,23,42,.25);
    }
    .imgBox img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .imgErr{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
      padding:10px;
      text-align:center;
      line-height:1.4;
    }

    .vals{
      padding:10px 10px 12px;
      border-top:1px solid rgba(148,163,184,.12);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .line{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .tag{ color:var(--muted); }
    .hint{
      color: var(--muted);
      font-size: 11px;
      line-height: 1.35;
      opacity: .95;
    }

    .empty{ padding:18px 14px; color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
<header>
  <div class="leftHead">
    <strong>订单图片 Viewer</strong>
    <span>左侧订单列表（↑/↓切换） · 右侧显示全部图片与 Pred/GT（1,1,1,1,1）</span>
  </div>
  <div class="ctl">
    <div class="search">
      <input id="searchInput" class="mono" placeholder="输入订单号关键词…" />
      <button id="searchBtn">Search</button>
    </div>
    <button id="reloadBtn">Reload data_orders.json</button>
  </div>
</header>

<div class="wrap">
  <!-- 左：订单列表 -->
  <aside class="panel">
    <div class="ph">
      <strong style="font-size:14px;">订单列表</strong>
      <div class="pill" id="countPill"><span class="dot"></span><span>orders: -</span></div>
    </div>
    <div class="kbdTip">键盘：↑/↓ 切换订单（焦点不在输入框时生效）</div>
    <div class="list" id="orderList"></div>
  </aside>

  <!-- 右：详情 -->
  <main class="main">

    <section class="panel">
      <div class="ph">
        <strong style="font-size:14px;">订单图片（全部展示）</strong>
        <div class="pill" id="imgCountPill"><span class="dot"></span><span>images: -</span></div>
      </div>
      <div class="imgs" id="imgGrid"></div>
    </section>
    <section class="panel">
      <div class="ph">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div style="font-size:12px;color:var(--muted);">当前订单</div>
          <div id="oid" class="mono" style="font-size:13px;">-</div>
        </div>
        <div class="pill" id="orderPill"><span class="dot"></span><span>订单：-</span></div>
      </div>
      <div class="meta" id="orderMeta"></div>
    </section>
  </main>
</div>

<script>
  const STEP_KEYS = ["step1_valid_pod","step2_has_package","step3_not_in_mailbox","step4_valid_location","overall_pass"];
  const STEP_HINT = "step1有效pod,step2包裹,step3不在邮箱,step4妥投环境有效,overall整体通过";

  const $ = s => document.querySelector(s);

  let DATA = null;
  let activeIdx = 0;

  function dotClass(v){
    if (v === 1) return "ok";
    if (v === 0) return "bad";
    return "";
  }
  function valText(v){
    return (v === 0 || v === 1) ? String(v) : "-";
  }
  function vecToText(obj){
    if (!obj) return "-";
    return STEP_KEYS.map(k => valText(obj[k])).join(",");
  }

  async function loadData(){
    const res = await fetch("data_orders.json?_=" + Date.now());
    DATA = await res.json();
    activeIdx = 0;
  }

  function renderOrderList(){
    const orders = DATA.orders || [];
    $("#countPill").querySelector("span:last-child").textContent = `orders: ${orders.length}`;

    const list = $("#orderList");
    list.innerHTML = orders.map((o, i) => {
      const pred = o.pred_order_pass;
      const gt = o.gt_order_pass;
      return `
        <div class="item ${i===activeIdx ? "active":""}" data-idx="${i}">
          <div class="id mono">${o.order_id}</div>
          <div class="miniPill">
            <span class="dot ${dotClass(pred)}"></span>
            <span>Pred=${valText(pred)} / GT=${gt===null? "-" : valText(gt)}</span>
          </div>
        </div>
      `;
    }).join("");

    list.querySelectorAll(".item").forEach(el => {
      el.addEventListener("click", () => {
        setActive(Number(el.dataset.idx));
      });
    });
  }

  function setActive(idx){
    const orders = DATA.orders || [];
    if (idx < 0 || idx >= orders.length) return;
    activeIdx = idx;
    renderOrderList();
    renderOrderDetail(orders[activeIdx]);
    ensureActiveVisible();
  }

  function ensureActiveVisible(){
    const list = $("#orderList");
    const active = list.querySelector(".item.active");
    if (!active) return;
    const ar = active.getBoundingClientRect();
    const lr = list.getBoundingClientRect();
    if (ar.top < lr.top) active.scrollIntoView({block:"nearest"});
    else if (ar.bottom > lr.bottom) active.scrollIntoView({block:"nearest"});
  }

  function renderOrderDetail(order){
    $("#oid").textContent = order.order_id;

    const predOrder = order.pred_order_pass;
    const gtOrder = order.gt_order_pass;

    const pill = $("#orderPill");
    const dot = pill.querySelector(".dot");
    dot.className = "dot " + dotClass(predOrder);
    pill.querySelector("span:last-child").textContent =
      `订单 Pred=${valText(predOrder)} / GT=${gtOrder===null? "-" : valText(gtOrder)}`;

    const meta = $("#orderMeta");
    meta.innerHTML = `
      <div class="row">
        <div class="k">订单合格规则</div>
        <div class="v"><span class="tag">任意图片 overall_pass=1 → 订单=1</span></div>
      </div>
      <div class="row">
        <div class="k">图片级 overall_pass</div>
        <div class="v"><span class="tag">step1~step4 全为 1 才为 1</span></div>
      </div>
      <div class="row">
        <div class="k">顺序说明</div>
        <div class="v"><span class="mono">${STEP_HINT}</span></div>
      </div>
      <div class="row">
        <div class="k">图片数量</div>
        <div class="v"><span class="mono">${order.images.length}</span></div>
      </div>
    `;

    $("#imgCountPill").querySelector("span:last-child").textContent = `images: ${order.images.length}`;

    const grid = $("#imgGrid");
    grid.innerHTML = order.images.map((it, i) => {
      const predVec = vecToText(it.pred);
      const gtVec = it.gt ? vecToText(it.gt) : "-";
      const src = it.image_src;

      return `
        <div class="imgcard">
          <div class="imgTop">
            <div class="left">
              <div class="idx mono">#${i+1}</div>
              <div class="order mono" title="${it.image_name}">${it.image_name}</div>
            </div>
          </div>

          <div class="imgBox">
            <img src="${src}" alt="${it.image_name}" loading="lazy"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'; this.nextElementSibling.querySelector('.mono').textContent=this.getAttribute('src');" />
            <div class="imgErr" style="display:none;">
              图片加载失败<br/>
              <span class="mono"></span>
            </div>
          </div>

          <div class="vals">
            <div class="line">
              <span class="tag">Pred</span>
              <span class="mono">${predVec}</span>
            </div>
            <div class="line">
              <span class="tag">GT</span>
              <span class="mono">${gtVec}</span>
            </div>
            <div class="hint mono">${STEP_HINT}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  function bindKeyboard(){
    window.addEventListener("keydown", (e) => {
      // 避免在输入控件中抢键
      const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
      if (tag === "input" || tag === "textarea" || tag === "select") return;

      if (e.key === "ArrowUp"){
        e.preventDefault();
        setActive(activeIdx - 1);
      } else if (e.key === "ArrowDown"){
        e.preventDefault();
        setActive(activeIdx + 1);
      }
    });
  }

  function normalize(s){
    return (s || "").trim().toLowerCase();
  }

  function searchAndActivate(q){
    const key = normalize(q);
    if (!key){
      alert("请输入订单号关键词");
      return;
    }
    const orders = DATA?.orders || [];
    const hit = orders.findIndex(o => normalize(o.order_id).includes(key));
    if (hit === -1){
      alert("未找到匹配订单");
      return;
    }
    setActive(hit);
  }

  async function boot(){
    await loadData();
    bindKeyboard();
    renderOrderList();
    const first = DATA.orders?.[0];
    if (first) renderOrderDetail(first);

    // 搜索按钮 / 回车
    $("#searchBtn").addEventListener("click", () => {
      searchAndActivate($("#searchInput").value);
    });
    $("#searchInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchAndActivate(e.target.value);
    });

    $("#reloadBtn").addEventListener("click", async () => {
      await loadData();
      renderOrderList();
      if (DATA.orders?.[0]) renderOrderDetail(DATA.orders[0]);
    });
  }

  boot();
</script>
</body>
</html>
