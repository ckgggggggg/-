<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dataset Viewer</title>
  <style>
    :root { --bg:#0b0f17; --panel:#111827; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
          background:var(--bg); color:var(--text); }
    header{ padding:12px 16px; border-bottom:1px solid var(--border); background:rgba(17,24,39,.7); position:sticky; top:0; backdrop-filter: blur(8px); }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input, select, button{
      background:var(--panel); border:1px solid var(--border); color:var(--text);
      padding:8px 10px; border-radius:10px; outline:none;
    }
    button{ cursor:pointer; }
    .wrap{ display:grid; grid-template-columns: 520px 1fr; height: calc(100vh - 58px); }
    .left{ border-right:1px solid var(--border); background:rgba(17,24,39,.35); overflow:auto; padding:12px; }
    .right{ overflow:auto; padding:12px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{
      padding:10px; border:1px solid var(--border); border-radius:14px; background:rgba(15,23,42,.5);
      display:flex; justify-content:space-between; gap:8px; cursor:pointer;
    }
    .item:hover{ border-color:#334155; }
    .item.active{ border-color:#60a5fa; box-shadow:0 0 0 1px rgba(96,165,250,.35) inset; }
    .name{ font-size:12px; color:var(--muted); word-break:break-all; }
    .badge{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }
    .badge.pass{ color:#86efac; border-color:rgba(134,239,172,.35); }
    .badge.fail{ color:#fca5a5; border-color:rgba(252,165,165,.35); }
    .card{ background:rgba(15,23,42,.6); border:1px solid var(--border); border-radius:16px; padding:12px; margin-bottom:12px; }
    .hint{ color:var(--muted); font-size:12px; }
    .grid{ display:grid; grid-template-columns: 1fr 100px; gap:8px 10px; align-items:center; }
    .k{ color:var(--muted); font-size:12px; }
    .v{ text-align:right; font-variant-numeric: tabular-nums; }
    img{ max-width:100%; border-radius:16px; border:1px solid var(--border); background:#020617; }
    code{ background:rgba(148,163,184,.15); padding:2px 6px; border-radius:8px; border:1px solid rgba(148,163,184,.18); }
    @media (max-width: 900px){
      .wrap{ grid-template-columns: 1fr; }
      .left{ border-right:none; border-bottom:1px solid var(--border); height: 44vh; }
      .right{ height: 56vh; }
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <strong>Dataset Viewer</strong>
    <span class="hint">左侧：条目与标注；右侧：图片预览</span>
    <span style="flex:1;"></span>
    <input id="q" placeholder="搜索文件名…" />
    <select id="filter">
      <option value="all">全部</option>
      <option value="pass">overall_pass=1</option>
      <option value="fail">overall_pass=0</option>
    </select>
    <button id="copyLink">复制当前条目链接</button>
  </div>
</header>

<div class="wrap">
  <aside class="left">
    <div class="card">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
        <div>
          <div style="font-weight:600;">数据</div>
          <div class="hint" id="stat">加载中…</div>
        </div>
        <div class="hint">快捷键：↑/↓ 切换</div>
      </div>
    </div>
    <div class="list" id="list"></div>
  </aside>

  <main class="right">
    <div class="card" id="meta"></div>
    <img id="img" alt="image preview" />
    <div class="hint" style="margin-top:10px;">
      分享定位：URL 后带 <code>#image3.png</code> 可直接打开对应条目。
    </div>
  </main>
</div>

<script>
  const STEP_KEYS = [
    "step1_valid_pod",
    "step2_has_package",
    "step3_not_in_mailbox",
    "step4_valid_location",
  ];

  const state = { all: [], filtered: [], idx: 0 };

  function badge(pass){
    const cls = pass ? "badge pass" : "badge fail";
    return `<span class="${cls}">${pass ? "PASS" : "FAIL"}</span>`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderList(){
    const list = document.getElementById("list");
    list.innerHTML = "";
    state.filtered.forEach((item, i) => {
      const div = document.createElement("div");
      div.className = "item" + (i === state.idx ? " active" : "");
      const pass = Number(item.overall_pass) === 1;
      div.innerHTML = `
        <div style="min-width:0;">
          <div style="font-weight:600; font-size:13px;">${escapeHtml(item.image_name ?? ("item_"+i))}</div>
          <div class="name">${escapeHtml(item.label?.raw ?? "")}</div>
        </div>
        ${badge(pass)}
      `;
      div.onclick = () => { state.idx = i; syncToUI(true); };
      list.appendChild(div);
    });
  }

  function renderMeta(item){
    const meta = document.getElementById("meta");
    if (!item){
      meta.innerHTML = `<div class="hint">无数据</div>`;
      return;
    }
    const pass = Number(item.overall_pass) === 1;

    const byKey = item.label?.by_key || {};
    const rows = STEP_KEYS.map(k => {
      const v = byKey[k];
      const show = (v === null || v === undefined || v === "") ? "N/A" : v;
      return `<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(show)}</div>`;
    }).join("");

    meta.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; margin-bottom:10px;">
        <div>
          <div style="font-weight:700; font-size:16px;">${escapeHtml(item.image_name ?? "")}</div>
          <div class="hint">标注文件：<code>${escapeHtml(item.label_relpath ?? "")}</code></div>
          <div class="hint">原始行：<code>${escapeHtml(item.label?.raw ?? "")}</code></div>
        </div>
        ${badge(pass)}
      </div>
      <div class="grid">${rows}</div>
    `;
  }

  function syncToUI(pushHash){
    if (state.idx < 0) state.idx = 0;
    if (state.idx >= state.filtered.length) state.idx = state.filtered.length - 1;

    renderList();
    const item = state.filtered[state.idx];
    renderMeta(item);

    const img = document.getElementById("img");
    img.src = item?.image_relpath || "";
    img.onerror = () => { img.alt = "图片加载失败：请检查 image/ 目录与文件名是否匹配"; };

    if (pushHash && item?.image_name){
      location.hash = encodeURIComponent(item.image_name);
    }
  }

  function applyFilter(){
    const q = document.getElementById("q").value.trim().toLowerCase();
    const f = document.getElementById("filter").value;

    state.filtered = state.all.filter(item => {
      const name = (item.image_name ?? "").toLowerCase();
      if (q && !name.includes(q)) return false;
      const pass = Number(item.overall_pass) === 1;
      if (f === "pass" && !pass) return false;
      if (f === "fail" && pass) return false;
      return true;
    });

    const h = decodeURIComponent((location.hash || "").replace(/^#/, ""));
    if (h){
      const newIdx = state.filtered.findIndex(x => (x.image_name ?? "") === h);
      state.idx = newIdx >= 0 ? newIdx : 0;
    } else {
      state.idx = 0;
    }

    document.getElementById("stat").textContent = `总数 ${state.all.length}，当前 ${state.filtered.length}`;
    syncToUI(false);
  }

  async function init(){
    const resp = await fetch("data.json", { cache: "no-store" });
    const data = await resp.json();
    state.all = Array.isArray(data) ? data : [];

    document.getElementById("q").addEventListener("input", applyFilter);
    document.getElementById("filter").addEventListener("change", applyFilter);
    window.addEventListener("hashchange", applyFilter);

    document.getElementById("copyLink").addEventListener("click", async () => {
      const item = state.filtered[state.idx];
      const url = location.origin + location.pathname + (item?.image_name ? ("#" + encodeURIComponent(item.image_name)) : "");
      try{ await navigator.clipboard.writeText(url); alert("已复制链接"); }
      catch(e){ prompt("复制失败，请手动复制：", url); }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowDown"){ state.idx = Math.min(state.idx + 1, state.filtered.length - 1); syncToUI(true); }
      if (e.key === "ArrowUp"){ state.idx = Math.max(state.idx - 1, 0); syncToUI(true); }
    });

    applyFilter();
  }

  init().catch(err => {
    console.error(err);
    document.getElementById("stat").textContent = "加载失败：请检查 data.json 是否存在且为 JSON 数组";
  });
</script>
</body>
</html>
